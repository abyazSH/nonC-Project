# ============================================================
# 1. IMPORT LIBRARIES
# ============================================================
import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import accuracy_score

from lightgbm import LGBMClassifier
from skl2onnx import convert_sklearn
from skl2onnx.common.data_types import FloatTensorType

import joblib


# ============================================================
# 2. LOAD DATA
# ============================================================
data = pd.read_csv('StudentPerformanceFactors.csv')

# Drop kolom tidak dipakai
columns_to_remove = ['Parental_Education_Level', 'Distance_from_Home', 'Teacher_Quality']
data = data.drop(columns=columns_to_remove, errors='ignore')


# ============================================================
# 3. BUAT LABEL "Kategori"
# ============================================================
def kategori(score):
    if 81 <= score <= 100:
        return 'A'
    elif 76 <= score <= 80:
        return 'AB'
    elif 66 <= score <= 75:
        return 'B'
    elif 50 <= score <= 65:
        return 'C'
    elif 0 <= score < 50:
        return 'F'
    else:
        return 'Tidak Valid'

data['Kategori'] = data['Exam_Score'].apply(kategori)


# ============================================================
# 4. PILIH FITUR INPUT
# ============================================================
fitur_input = [
    'Hours_Studied', 'Attendance', 'Extracurricular_Activities',
    'Sleep_Hours', 'Previous_Scores', 'Motivation_Level',
    'Tutoring_Sessions', 'Physical_Activity', 'Learning_Disabilities'
]

X = data[fitur_input]
y = data['Kategori']

# One-hot encoding
X_encoded = pd.get_dummies(X)

# Encode label target
le = LabelEncoder()
y_enc = le.fit_transform(y)

# Split data
X_train, X_test, y_train, y_test = train_test_split(
    X_encoded, y_enc, test_size=0.2, random_state=42, stratify=y_enc
)


# ============================================================
# 5. TRAIN MODEL (LightGBM)
# ============================================================
model = LGBMClassifier(
    n_estimators=300,
    learning_rate=0.1,
    random_state=42
)

model.fit(X_train, y_train)

y_pred = model.predict(X_test)
print("Akurasi:", accuracy_score(y_test, y_pred))


# ============================================================
# 6. SIMPAN INFORMASI PENTING UNTUK ANDROID
# ============================================================

# Simpan label encoder
np.save("label_classes.npy", le.classes_)

# Simpan urutan kolom training (Wajib untuk Android)
joblib.dump(X_train.columns.tolist(), "input_columns.pkl")

print("Input columns disimpan:", len(X_train.columns))


# ============================================================
# 7. EXPORT MODEL KE ONNX
# ============================================================
initial_type = [("input", FloatTensorType([None, X_train.shape[1]]))]
onnx_model = convert_sklearn(model, initial_types=initial_type)

with open("model_klasifikasi.onnx", "wb") as f:
    f.write(onnx_model.SerializeToString())

print("MODEL ONNX SELESAI DIBUAT â†’ model_klasifikasi.onnx")


# ============================================================
# 8. CEK OUTPUT
# ============================================================
print("File yang dihasilkan:")
print(" - model_klasifikasi.onnx")
print(" - label_classes.npy")
print(" - input_columns.pkl")
